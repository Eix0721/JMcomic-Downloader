name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  verify:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.11"]

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r src/requirements.txt
    
    - name: Verify imports
      run: |
        cd src
        python -c "
        try:
            from libs.self.core import main
            print('✅ 核心模块导入成功')
            import jmcomic
            import InquirerPy
            import simpsave
            import yaml
            print('✅ 所有依赖导入成功')
        except Exception as e:
            print(f'❌ 导入失败: {e}')
            import traceback
            traceback.print_exc()
            exit(1)
        "
    
    - name: Check syntax
      run: |
        cd src
        python -m py_compile jmcomic_downloader.py
        echo "✅ 主程序语法检查通过"
        
    - name: Test basic functionality
      run: |
        cd src
        python -c "
        # 测试是否能正常启动（不执行实际下载）
        import sys
        sys.argv = ['jmcomic_downloader.py', '--help']
        try:
            exec(open('jmcomic_downloader.py').read())
            print('✅ 程序可以正常启动')
        except SystemExit:
            print('✅ 程序正常退出')
        except Exception as e:
            print(f'❌ 启动测试失败: {e}')
            exit(1)
        "