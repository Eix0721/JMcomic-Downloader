name: Build

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r src/requirements.txt
        pip install pyinstaller
    
    - name: Prepare build environment
      shell: pwsh
      run: |
        cd src
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "JMcomic Downloader.spec") { Remove-Item -Force "JMcomic Downloader.spec" }
    
    - name: Build with PyInstaller
      shell: pwsh
      run: |
        cd src
        pyinstaller `
          --onefile `
          --console `
          --name "JMcomic Downloader" `
          --icon="../assets/icon.ico" `
          --hidden-import "jmcomic" `
          --hidden-import "InquirerPy" `
          --hidden-import "simpsave" `
          --hidden-import "yaml" `
          jmcomic_downloader.py
        
        Write-Host "Build completed!"
        Get-ChildItem dist
    
    - name: Test the executable
      shell: pwsh
      run: |
        cd src/dist
        Write-Host "Testing executable..."
        & ".\JMcomic Downloader.exe" --help 2>&1 | Out-Null
        Write-Host "Executable test completed"
        $fileSize = (Get-Item "JMcomic Downloader.exe").Length
        Write-Host "Executable size: $fileSize bytes"
