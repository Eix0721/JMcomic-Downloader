name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # 匹配语义化版本标签，如 v1.0.0, v2.1.3

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取所有历史记录，用于生成变更日志
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r src/requirements.txt
        pip install pyinstaller
    
    - name: Prepare build environment
      run: |
        cd src
        # 清理之前的构建文件
        if exist "build" rmdir /s /q build
        if exist "dist" rmdir /s /q dist
        if exist "JMcomic Downloader.spec" del "JMcomic Downloader.spec"
    
    - name: Build with PyInstaller
      run: |
        cd src
        # 使用优化的 PyInstaller 配置
        pyinstaller ^
          --onefile ^
          --console ^
          --name "JMcomic Downloader" ^
          --icon="../assets/icon.ico" ^
          --hidden-import "jmcomic" ^
          --hidden-import "InquirerPy" ^
          --hidden-import "simpsave" ^
          --hidden-import "yaml" ^
          --add-data "../assets/icon.ico;assets" ^
          jmcomic_downloader.py
        
        echo "Build completed!"
        dir dist
    
    - name: Test the executable
      run: |
        cd src/dist
        echo "Testing executable..."
        # 测试可执行文件是否能运行（不实际下载）
        .\"JMcomic Downloader.exe" --help 2>&1 || echo "Executable test completed"
        # 获取文件大小（Windows PowerShell 方式）
        $fileSize = (Get-Item "JMcomic Downloader.exe").Length
        echo "Executable size: $fileSize bytes"
    - name: Prepare release assets
      run: |
        # 创建版本说明文件
        $version = $env:GITHUB_REF -replace 'refs/tags/v', ''
        $releaseNotes = @"
# JMcomic Downloader v$version

## 下载说明

1. 下载 `JMcomic Downloader.exe` 文件
2. 双击运行即可使用
3. 配置文件会自动在程序同目录生成

## 注意事项
- 首次运行会自动创建配置文件
- 请确保网络连接正常
- 程序需要 .NET Framework 4.5+ 或相应运行环境
"@
        
        Set-Content -Path "release_notes.md" -Value $releaseNotes
        
        # 复制可执行文件到根目录
        Copy-Item "src/dist/JMcomic Downloader.exe" "./JMcomic Downloader v$version.exe"
        
        echo "Release assets prepared"
        dir
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./JMcomic Downloader v*.exe
          ./release_notes.md
        generate_release_notes: true
        draft: false
        prerelease: false
        make_latest: true

